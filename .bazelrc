# Importing container/environment-specific configuration
# (autogenerated by generate_bazelrc.sh)
import %workspace%/generated.bazelrc

# This passes through the CONTAINER_IMAGE_DIGEST environment variable to all
# action environments. It is populated by build.sh and dev.sh with a hash of
# the build container image. This effectively partitions the cache by container
# image, avoiding incorrect cache hits (Bazel does not otherwise account for
# dependencies outside of the workspace).
build --action_env=CONTAINER_IMAGE_DIGEST
test --action_env=CONTAINER_IMAGE_DIGEST

# Don't show inactionable warnings when building (not using) external deps.
build --output_filter='^//((?!(external):).)*$'

# Always true in TensorFlow's .bazelrc
build --define=open_source_build=true
# Monolithic build (i.e. no libtensorflow_framework.so)
# The non-monolithic build seems to fail currently, due to symbols missing from
# libtensorflow_framework.so but needed by its dependencies. It is likely that
# this Bazel change is related: https://github.com/bazelbuild/bazel/issues/7362
build --define=framework_shared_object=false

# Disable some default TF features (avoids some build-time dependencies).
build --define=no_aws_support=true
build --define=no_gcp_support=true
build --define=no_hdfs_support=true
build --define=no_ignite_support=true
build --define=no_kafka_support=true
build --define=no_nccl_support=true

# Prevent gRPC from depending on c-ares. TF's bazelrc sets this. We also don't
# have a recent-enough version of the library in our build container.
build --define=grpc_no_ares=true

# googletest requires absl flags.
build --define=absl=1

# This results in -Werror for all FCP code, but nothing we pull in via
# repository rules (those labels have a @ prefix).
build --per_file_copt=+^//@-Werror
# We pull in some headers from TensorFlow which give the following warning, we
# don't want to convert them to errors.
build --per_file_copt=+^//@-Wno-error=inconsistent-missing-override
build --per_file_copt=+^//@-Wno-error=mismatched-tags
build --per_file_copt=+^//@-Wno-error=defaulted-function-deleted

# TF now has `cc_shared_library` targets, so it needs the experimental flag.
build --experimental_cc_shared_library

# Bazel defaults to --std=c++0x
build --cxxopt=-std=c++17
build --host_cxxopt=-std=c++17


# We avoid building with --compilation_mode=dbg usually, since the artifacts can
# be very large (a binary with TensorFlow linked in is >2GiB); it costs several
# minutes just to fetch them from RBE cache.
build --compilation_mode=opt

# Without this, bazel doesn't print all Java compilation errors.
build --javacopt="-verbose"

build:asan --compilation_mode=dbg
build:asan --strip=never
build:asan --copt=-fsanitize=address
build:asan --copt=-fno-omit-frame-pointer
build:asan --copt=-DADDRESS_SANITIZER  # used by absl
build:asan --linkopt=-fsanitize=address
build:asan --action_env=ASAN_OPTIONS=check_initialization_order=true:strict_init_order=true:strict_string_checks=true:detect_stack_use_after_return=true:detect_odr_violation=1
